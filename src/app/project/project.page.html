<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>{{ (activeProject$ | async )?.name }}</ion-title>
    <ion-select slot="end" interface="popover" [formControl]="range">
      <ion-select-option value="live">Live</ion-select-option>
      <ion-select-option value="today">Today</ion-select-option>
      <ion-select-option value="day">Yesterday</ion-select-option>
      <ion-select-option value="week">Last week</ion-select-option>
      <ion-select-option value="month">Last Month</ion-select-option>
    </ion-select>
  </ion-toolbar>
  <ion-toolbar *ngIf="(filters$ | async).length > 0">
    <ion-chip *ngFor="let filter of filters$ | async">
      <ion-label>{{ filter.label || filter.key }}: {{ filter.value }}</ion-label>
      <ion-icon name="close" (click)="clearFilter(filter.key)"></ion-icon>
    </ion-chip>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-grid [style]="{ '--total-page-view': totalPageCount$ | async,  '--total-user-count': totalUserCount$ | async }">
    <ion-row>
      <ion-col size="12" *ngIf="onboardingMode$ | async">
        <ion-card class="no-data-card">
          <ion-card-header>
            <ion-card-title>No Data</ion-card-title>
            <ion-card-subtitle>Did you add your tracker code to your website?</ion-card-subtitle>
          </ion-card-header>

          <ion-card-content>
            <p>You can put the code below before <code>&lt;/head&gt;</code> tag in your website:</p>
            <div class="code-example">
              <pre class="hljs" style="display: block; overflow-x: auto; padding: 0.5em; background: rgb(240, 240, 240); color: rgb(68, 68, 68);"><span class="hljs-tag">&lt;<span class="hljs-name" style="font-weight: 700;">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string" style="color: rgb(136, 0, 0);">"module"</span><br>  <span class="hljs-attr">data-driplane-token</span>=<span class="hljs-string" style="color: rgb(136, 0, 0);">"{{ activeProjectKey$ | async }}"</span><br>  <span class="hljs-attr">src</span>=<span class="hljs-string" style="color: rgb(136, 0, 0);">"https://cdn.jsdelivr.net/npm/&#64;driplane/web&#64;beta/dist/driplane.js"</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name" style="font-weight: 700;">script</span>&gt;</span></pre>

              <sl-copy-button value='&lt;script type="module" data-driplane-token="{{ activeProjectKey$ | async }}" src="https://cdn.jsdelivr.net/npm/&#64;driplane/web&#64;beta/dist/driplane.js"&gt;&lt;/script&gt;'></sl-copy-button>
            </div>

            <p>Then you will start to see your visitor insights in this dashboard.</p>
          </ion-card-content>
        </ion-card>
      </ion-col>

      <ion-col size-lg="6" size-md="6" size="12" *ngIf="(pageViewResult$ | async)?.length > 0">
        <ion-card class="chart-card">
          <ion-card-header>
            <ion-card-subtitle>Page views</ion-card-subtitle>
          </ion-card-header>

          <p class="total">{{ totalPageCount$ | async }}</p>
          <app-line-chart [data]="pageViewResult$ | async" valueLabel="Page views" [timeLabel]="chartTimeLabel$ | async" [dateFormat]="chartDateFormat$ | async"></app-line-chart>
        </ion-card>
      </ion-col>

      <ion-col size-lg="6" size-md="6" size="12" *ngIf="(users$ | async)?.length > 0">
        <ion-card class="chart-card">
          <ion-card-header>
            <ion-card-subtitle>Visitors</ion-card-subtitle>
          </ion-card-header>

          <p class="total">{{ totalUserCount$ | async }}</p>
          <app-line-chart [data]="users$ | async" valueLabel="Visitors" [timeLabel]="chartTimeLabel$ | async" [dateFormat]="chartDateFormat$ | async"></app-line-chart>
        </ion-card>
      </ion-col>

      <ion-col size-lg="3" size-md="4" size-sm="12" *ngIf="(hasFilter('url_host') | async) === false && (topHosts$ | async)?.length > 0">
        <ion-card class="bar-chart-card">
          <ion-item lines="none">
            <ion-label>Domains</ion-label>
            <ion-button id="top-domains-detail" *ngIf="(topHosts$ | async)?.length > 9" slot="end" color="medium" fill="clear" size="small"><ion-icon slot="icon-only" name="expand"></ion-icon></ion-button>
          </ion-item>

          <ion-card-content>
            <ul>
              <li *ngFor="let item of topHosts$ | async" [style]="{ '--item-value': item.count}">
                <a class="label" (click)="addFilter('url_host', item.label, 'Domain')">{{ item.label }}</a>
                <span>{{ item.count | number }}</span>
              </li>
            </ul>
          </ion-card-content>
        </ion-card>

        <ion-modal #topHostsModal trigger="top-domains-detail">
          <ng-template>
            <ion-header>
              <ion-toolbar>
                <ion-title>Domains</ion-title>
                <ion-buttons slot="end">
                  <ion-button [strong]="true" (click)="topHostsModal.dismiss()">Close</ion-button>
                </ion-buttons>
              </ion-toolbar>
            </ion-header>
            <ion-content class="ion-padding" color="light">
              <ion-list inset>
                <ion-item>
                  <ion-label><strong>Domain</strong></ion-label>
                  <ion-note slot="end"><strong>Page views</strong></ion-note>
                </ion-item>
                <ion-item *ngFor="let item of topHostsFull$ | async">
                  <ion-label>{{ item.label }}</ion-label>
                  <ion-note slot="end">{{ item.count | number }}</ion-note>
                </ion-item>
              </ion-list>
            </ion-content>
          </ng-template>
        </ion-modal>
      </ion-col>

      <ion-col size-lg="3" size-md="4" size-sm="12" *ngIf="(hasFilter('url_path') | async) === false && (topUrls$ | async)?.length > 0">
        <ion-card class="bar-chart-card">
          <ion-item lines="none">
            <ion-label>Top URLs</ion-label>
            <ion-button id="top-urls-detail" *ngIf="(topUrls$ | async)?.length > 9" slot="end" color="medium" fill="clear" size="small"><ion-icon slot="icon-only" name="expand"></ion-icon></ion-button>
          </ion-item>

          <ion-card-content>
            <ul>
              <li *ngFor="let item of topUrls$ | async" [style]="{ '--item-value': item.count}">
                <a class="label" (click)="addFilter('url_path', item.label, 'URL')">{{ item.label }}</a>
                <span>{{ item.count | number }}</span>
              </li>
            </ul>
          </ion-card-content>
        </ion-card>

        <ion-modal #topUrlsModal trigger="top-urls-detail">
          <ng-template>
            <ion-header>
              <ion-toolbar>
                <ion-title>Top URLs</ion-title>
                <ion-buttons slot="end">
                  <ion-button [strong]="true" (click)="topUrlsModal.dismiss()">Close</ion-button>
                </ion-buttons>
              </ion-toolbar>
            </ion-header>
            <ion-content class="ion-padding" color="light">
              <ion-list inset>
                <ion-item>
                  <ion-label><strong>URL</strong></ion-label>
                  <ion-note slot="end"><strong>Page views</strong></ion-note>
                </ion-item>
                <ion-item *ngFor="let item of topUrlsFull$ | async">
                  <ion-label>{{ item.label }}</ion-label>
                  <ion-note slot="end">{{ item.count | number }}</ion-note>
                </ion-item>
              </ion-list>
            </ion-content>
          </ng-template>
        </ion-modal>
      </ion-col>

      <ion-col size-lg="3" size-md="4" size-sm="12" *ngIf="(hasFilter('ref_host') | async) === false && (topSources$ | async)?.length > 0">
        <ion-card class="bar-chart-card">
          <ion-item lines="none">
            <ion-text>Sources</ion-text>
            <ion-button id="sources-detail" *ngIf="(topSources$ | async)?.length > 9" slot="end" color="medium" fill="clear" size="small"><ion-icon slot="icon-only" name="expand"></ion-icon></ion-button>
          </ion-item>

          <ion-card-content>
            <ul>
              <li *ngFor="let item of topSources$ | async" [style]="{ '--item-value': item.count}">
                <a class="label" (click)="addFilter('ref_host', item.label, 'Source')">{{ item.label }}</a>
                <span>{{ item.count | number }}</span>
              </li>
            </ul>
          </ion-card-content>
        </ion-card>

        <ion-modal #sourcesModal trigger="sources-detail">
          <ng-template>
            <ion-header>
              <ion-toolbar>
                <ion-title>Sources</ion-title>
                <ion-buttons slot="end">
                  <ion-button [strong]="true" (click)="sourcesModal.dismiss()">Close</ion-button>
                </ion-buttons>
              </ion-toolbar>
            </ion-header>
            <ion-content class="ion-padding" color="light">
              <ion-list inset>
                <ion-item>
                  <ion-label><strong>Source Domain</strong></ion-label>
                  <ion-note slot="end"><strong>Page views</strong></ion-note>
                </ion-item>
                <ion-item *ngFor="let item of topSourcesFull$ | async" [style]="{ '--item-value': item.count}">
                  <ion-label>{{ item.label }}</ion-label>
                  <ion-note slot="end">{{ item.count | number }}</ion-note>
                </ion-item>
              </ion-list>
            </ion-content>
          </ng-template>
        </ion-modal>
      </ion-col>

      <ion-col size-lg="3" size-md="4" size-sm="12" *ngIf="(hasFilter('ref') | async) === false && (topSourcesUrls$ | async)?.length > 0">
        <ion-card class="bar-chart-card">
          <ion-item lines="none">
            <ion-text>Source URLs</ion-text>
            <ion-button id="source-urls-detail" *ngIf="(topSourcesUrls$ | async)?.length > 9" slot="end" color="medium" fill="clear" size="small"><ion-icon slot="icon-only" name="expand"></ion-icon></ion-button>
          </ion-item>

          <ion-card-content>
            <ul>
              <li *ngFor="let item of topSourcesUrls$ | async" [style]="{ '--item-value': item.count}">
                <a class="label" (click)="addFilter('ref', item.label, 'Source')">{{ item.label }}</a>
                <span>{{ item.count | number }}</span>
              </li>
            </ul>
          </ion-card-content>
        </ion-card>

        <ion-modal #sourceURLsModal trigger="source-urls-detail">
          <ng-template>
            <ion-header>
              <ion-toolbar>
                <ion-title>Source URLs</ion-title>
                <ion-buttons slot="end">
                  <ion-button [strong]="true" (click)="sourceURLsModal.dismiss()">Close</ion-button>
                </ion-buttons>
              </ion-toolbar>
            </ion-header>
            <ion-content class="ion-padding" color="light">
              <ion-list inset>
                <ion-item>
                  <ion-label><strong>Source URL</strong></ion-label>
                  <ion-note slot="end"><strong>Page views</strong></ion-note>
                </ion-item>
                <ion-item *ngFor="let item of topSourceUrlsFull$ | async">
                  <ion-label>{{ item.label }}</ion-label>
                  <ion-note slot="end">{{ item.count | number }}</ion-note>
                </ion-item>
              </ion-list>
            </ion-content>
          </ng-template>
        </ion-modal>
      </ion-col>

      <ion-col size-lg="3" size-md="4" size-sm="12" *ngIf="(hasFilter('ua_br', 'ua_os') | async) === false && (topEnvType$ | async)?.length > 0">
        <ion-card class="bar-chart-card">
          <ion-item lines="none">
            <!-- <ion-icon slot="start" size="small" name="desktop-outline"></ion-icon> -->
            <ion-select interface="popover" value="ua_br" [formControl]="envType" placeholder="Visitor Software">
              <ion-select-option value="ua_br">Browsers</ion-select-option>
              <ion-select-option value="ua_os">Operating Systems</ion-select-option>
            </ion-select>
            <!-- <ion-button slot="end" color="medium" fill="clear" size="small"><ion-icon slot="icon-only" name="expand"></ion-icon></ion-button> -->
          </ion-item>

          <ion-card-content>
            <ul>
              <li *ngFor="let item of topEnvType$ | async" [style]="{ '--item-value': item.count}">
                <a class="label" (click)="addFilter(envType.value, item.label, envType.value === 'ua_br' ? 'Browser' : 'OS')">{{ item.label }}</a>
                <span>{{ item.count | number }}</span>
              </li>
            </ul>
          </ion-card-content>
        </ion-card>
      </ion-col>

      <ion-col size-lg="3" size-md="4" size-sm="12" *ngIf="(hasFilter('ua_br') | async) && (topBrowserVersions$ | async)?.length > 0">
        <ion-card class="bar-chart-card">
          <ion-item lines="none">
            <ion-label>Browser Versions</ion-label>
          </ion-item>

          <ion-card-content>
            <ul>
              <li *ngFor="let item of topBrowserVersions$ | async" [style]="{ '--item-value': item.count}">
                <a class="label" (click)="addFilter('ua_br_v', item.label, 'Browser Version')">{{ item.label }}</a>
                <span>{{ item.count | number }}</span>
              </li>
            </ul>
          </ion-card-content>
        </ion-card>
      </ion-col>

      <ion-col size-lg="3" size-md="4" size-sm="12" *ngIf="(hasFilter('ua_dv_t', 'ua_dv', 'ua_dv_v') | async) === false && (topDevType$ | async)?.length > 0">
        <ion-card class="bar-chart-card">
          <ion-item lines="none">
            <ion-select interface="popover" value="ua_dv_t" [formControl]="devType" placeholder="Visitor Device">
              <ion-select-option value="ua_dv_t">Device Types</ion-select-option>
              <ion-select-option value="ua_dv_v">Vendors</ion-select-option>
              <ion-select-option value="ua_dv">Models</ion-select-option>
            </ion-select>
          </ion-item>

          <ion-card-content>
            <ul>
              <li *ngFor="let item of topDevType$ | async" [style]="{ '--item-value': item.count}">
                <a class="label" (click)="addFilter(devType.value, item.label, 'Device')">{{ item.label }}</a>
                <span>{{ item.count | number }}</span>
              </li>
            </ul>
          </ion-card-content>
        </ion-card>
      </ion-col>

      <ion-col size="12" class="perf-stats" [hidden]="(onboardingMode$ | async)">
        <ion-card>
          <ion-item lines="none">
            <ion-label>Performance</ion-label>
          </ion-item>

          <ion-card-content>
            <ng-template #gauge let-item>
              <figure>
                <svg class="gauge" [style.--value]="item.data?.percentages.value" width="100%" height="100%" viewBox="0 0 42 42" role="img">
                  <circle class="gauge-segment-poor" cx="21" cy="21" r="15.91549430918954" stroke-width="3" attr.stroke-dasharray="{{ item.data?.percentages.poor * .75 }} {{ 100 - item.data?.percentages.poor * .75 }}" attr.stroke-dashoffset="{{ 62.5 - item.data?.percentages.improve * .75 - item.data?.percentages.good * .75 }}"></circle>
                  <circle class="gauge-segment-improve" cx="21" cy="21" r="15.91549430918954" stroke-width="3" attr.stroke-dasharray="{{ item.data?.percentages.improve * .75 }} {{ 100 - item.data?.percentages.improve * .75 }}" attr.stroke-dashoffset="{{ 62.5 - item.data?.percentages.good * .75}}"></circle>
                  <circle class="gauge-segment-good" cx="21" cy="21" r="15.91549430918954" stroke-width="3" attr.stroke-dasharray="{{ item.data?.percentages.good * .75 }} {{ 100 - item.data?.percentages.good * .75 }}" stroke-dashoffset="62.5"></circle>

                  <circle cx="21" cy="21" r="15.91549430918954" class="pointer" stroke="black" stroke-dasharray="1 99"></circle>

                  <g class="chart-text {{ item.data?.state }}">
                    <text x="50%" y="50%" class="chart-number" *ngIf="item.label === 'CLS'">
                      {{ item.data?.value | number:'1.1-4' }}
                    </text>
                    <text x="50%" y="50%" class="chart-number" *ngIf="item.label !== 'CLS'">
                      {{ item.data?.value | number:'1.0-0' }}ms
                    </text>
                    <text x="50%" y="50%" class="chart-label">
                      {{ item.label }}
                    </text>
                  </g>
                </svg>
              </figure>
            </ng-template>

            <ng-container *ngTemplateOutlet="gauge; context: { $implicit: { label: 'TTFB', data: perfTTFBAvg$ | async } }"></ng-container>
            <ng-container *ngTemplateOutlet="gauge; context: { $implicit: { label: 'FCP',  data: perfFCPAvg$ | async } }"></ng-container>
            <ng-container *ngTemplateOutlet="gauge; context: { $implicit: { label: 'LCP',  data: perfLCPAvg$ | async } }"></ng-container>
            <ng-container *ngTemplateOutlet="gauge; context: { $implicit: { label: 'FID',  data: perfFIDAvg$ | async } }"></ng-container>
            <ng-container *ngTemplateOutlet="gauge; context: { $implicit: { label: 'CLS',  data: perfCLSAvg$ | async } }"></ng-container>
            <ng-container *ngTemplateOutlet="gauge; context: { $implicit: { label: 'INP',  data: perfINPAvg$ | async } }"></ng-container>

          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>
